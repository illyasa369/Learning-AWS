# Load Balancing and Scalability

## Scalability
Scalability - The ability of a system to handle greater loads by scaling.

Two kinds of scaling:
- Vertical Scaling: Increasing the size of the instance.
- Horizontal Scaling: Increasing the number of instances.
<br>

## High Availability
High Availability (HA): The process of keeping systems running even if something fails.

In AWS, HA is achieved by utilizing multiple AZs. If one AZ fails, another takes over.

Two types of HA:
- Passive: One main system and a standby system.
- Active: Multiple systems running at the same time.
<br>

## Load Balancers
Load balancers are servers that distribute incoming traffic across multiple downstream servers.

Benefits of using a Load Balancer:
- Spreads traffic across many servers so no server is overwhelmed by traffic.
- Gives one DNS endpoint for users.
- Regular health checks for instances.
- Handles instance failures - Stops sending traffic to unhealthy instances.
- Keeps users on the same servers (sticky sessions).
- Improves availability across AZs.
- Handles HTTPS security.

Benefits of using AWS ELBs:
- Managed service: AWS handles upgrades, maintenance and HA.
- Integration with many AWS services (EC2, ASG, Route 53, CloudWatch).
<br>

### Health Checks
Indicates to a load balancer whether a server is operational or not.

- The LB sends a request to a port + path (/health).
- Expects a 200 OK response.
- If a server is unhealthy, the LB stops sending traffic to it.
<br>

### Types of Load Balancers on AWS
- Classic Load Balancers, CLB
- Application Load Balancers, ALB: Best for HTTP/HTTPS traffic.
- Network Load Balancers, NLB: Best for low-latency, high-performance TCP/UDP traffic.
- Gateway Load Balancers, GLB: Used to route and scale traffic through virtual appliances.
<br>

### Load Balancer Security Groups
- Classic and Application Load Balancers use security groups.

- Load Balancers and EC2 instances use separate SGs.

- The Load Balancer's SG allows inbound HTTP and HTTPS traffic from 0.0.0.0/0 (public internet).

- The EC2 instance’s security group allows HTTP traffic only from the Load Balancer’s security group, so users cannot access the instance directly.
<br>

### Application Load Balancers
- Operates at layer 7.
- Handles HTTP and HTTPS requests.
- Can inspect request content; URL paths, hostnames, headers, query strings and so on.
- Routes traffic to multiple target groups. Targets can be EC2 instances, Containers (ECS) or Lambda functions.
<br>

Good to know:
- Client connections end at the ALB, EC2 sees the ALB's private and not client info (IP address, Port, Protocol).
- Client information included in HTTP headers.
- Application must read these headers to get the true client info (for logging, analytics, geolocation, security, etc).
<br>

### Network Load Balancers
- Operates at layer 4.
- Forwards traffic without inspecting HTTP headers or terminating SSL.
- Routes traffic based on ports or protocols to target groups, not content like ALBs.
<br>

### Sticky Sessions
- Sticky sessions ensure that a client is always connected to the same server during a session.
- Works with CLB, ALB and NLB.
- For CLB and ALB, stickiness has an expiration date that can be set.
- Use case: Making sure a user doesn't lose their session data.
- Drawback: Can cause uneven load if certain servers are receiving more traffic than others.
<br>

### SSL/TLS
- SSL: Secure Sockets Layer.
- TLS: Transport Layer Security (Newer version of SSL).
<br>

- An SSL/TLS certificate encrypts data while it is being sent between a client and a server.
- Public SSL certificates are issued by the Certificate Authority.
- Certificates have an expiration date and must be renewed.
<br>

#### Load Balancers - SSL Certificates
- Load Balancers use X.509 certificates (SSL/TLS certificates).
- Certificates managed using AWS Certificate Manager, ACM.
- Alternatively, certificates can be uploaded.
<br>

- Load Balancers use an HTTPS listener on port 443 to accept HTTPS connections.
- A default certificate is required.
- For multiple domains, extra certificates can be added.
- When a client connects, it uses Server Name Indication which tells the LB which hostname it wants.
- The LB selects the matching certificate or the default one if no match exists.
<br>

#### Server Name Indication (SNI)
- Clients are required to indicate the hostname of the target server in the initial SSL handshake.
- The load balancer returns the certificate that matches the requested hostname, or the default certificate if no match is found.
- Only works with ALBs, NLBs and CloudFront.
<br>

#### SSL Termination at the Load Balancer
- Users connect to the LB using HTTPS (encrypted).
- LB decrypts the traffic using its SSL/TLS certificates.
- In the private VPC, traffic is sent to the instance using HTTP (not encrypted).
<br>

#### Connection Draining (for CLBs) / Deregistration Delay (for ALBs and NLBs)
- Prevents active user requests from being cut off when an instance is removed.
- The LB stops routing new traffic to the instance and waits for existing requests to finish.
- The time before an LB removes an instance can be configured.
  - 0 seconds (Instance removed instantly)
  - 3600 seconds (Maximum time)
  - 300 seconds is the default.
<br>

### Auto Scaling Group (ASG)
Service that automatically manages the number of EC2 instances, adding or removing them based on demand to keep applications running smoothly.

Features of ASGs:
- Ensures a minimum and a maximum number of instances are running.
- Automatically registers new instances to an LB.
- Can replace unhealthy or terminated instances.

ASGs are free; users only pay for the EC2 instances.

<br>

#### Integration with Load Balancers
- Load Balancers distribute traffic.
- Health checks are run on the instances.
- If a health check fails, the LB stops sending traffic to the unhealthy instance.
- The ASG replaces the unhealthy instance automatically from custom AMIs.
<br>

#### Integration with CloudWatch
- ASGs can scale based on CloudWatch alarms.
- Alarms can monitor metrics.
- CloudWatch alarms trigger when a metric reaches a threshold and activate scaling policies in ASG.
<br>

#### Scaling Policies
Target Tracking:
- Maintains the value of a metric (CPU at 40%) by adding and removing instances.

Step Scaling:
- Scale based on CloudWatch alarms.

Scheduled Scaling:
- Scale at specific times (for predictable traffic).
